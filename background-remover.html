<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penghapus Latar Belakang Gambar</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 800px;
        }
        .image-preview {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="container bg-white p-8 rounded-xl shadow-lg text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Penghapus Latar Belakang Gambar</h1>
        <p class="text-gray-600 mb-8">Unggah gambar Anda untuk menghapus latar belakangnya secara otomatis.</p>

        <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="previewImage(event)">
        <label for="imageInput" class="cursor-pointer inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition ease-in-out duration-150">
            Pilih Gambar
        </label>

        <div id="imagePreviewContainer" class="mt-8 hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Gambar Asli:</h2>
            <img id="originalImage" class="image-preview mx-auto mb-6" alt="Gambar Asli">
        </div>

        <button id="removeBackgroundButton" class="mt-8 px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 opacity-50 cursor-not-allowed transition ease-in-out duration-150" disabled onclick="removeBackground()">
            <span id="buttonText">Hapus Latar Belakang</span>
            <div id="loadingSpinner" class="loading-spinner hidden ml-2"></div>
        </button>

        <div id="resultContainer" class="mt-12 hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Hasil (Latar Belakang Dihapus):</h2>
            <img id="processedImage" class="image-preview mx-auto" alt="Gambar Tanpa Latar Belakang">
        </div>

        <div id="errorMessage" class="mt-8 text-red-600 font-medium hidden"></div>
    </div>

    <script type="module">
        const imageInput = document.getElementById('imageInput');
        const originalImage = document.getElementById('originalImage');
        const processedImage = document.getElementById('processedImage');
        const removeBackgroundButton = document.getElementById('removeBackgroundButton');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const resultContainer = document.getElementById('resultContainer');
        const errorMessage = document.getElementById('errorMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const buttonText = document.getElementById('buttonText');

        let selectedFileBase64 = null;

        /**
         * Mengubah ArrayBuffer menjadi string base64.
         * @param {ArrayBuffer} buffer - ArrayBuffer yang akan diubah.
         * @returns {string} String base64.
         */
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        /**
         * Mengubah string base64 menjadi ArrayBuffer.
         * @param {string} base64 - String base64 yang akan diubah.
         * @returns {ArrayBuffer} ArrayBuffer.
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Mempratinjau gambar yang dipilih dan mengaktifkan tombol hapus latar belakang.
         * @param {Event} event - Objek event perubahan input file.
         */
        window.previewImage = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    originalImage.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    selectedFileBase64 = e.target.result.split(',')[1]; // Simpan hanya bagian base64
                    removeBackgroundButton.disabled = false;
                    removeBackgroundButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    resultContainer.classList.add('hidden'); // Sembunyikan hasil sebelumnya
                    errorMessage.classList.add('hidden'); // Sembunyikan pesan error
                };
                reader.readAsDataURL(file);
            } else {
                imagePreviewContainer.classList.add('hidden');
                removeBackgroundButton.disabled = true;
                removeBackgroundButton.classList.add('opacity-50', 'cursor-not-allowed');
                selectedFileBase64 = null;
            }
        };

        /**
         * Menghapus latar belakang dari gambar yang dipilih menggunakan API Gemini.
         */
        window.removeBackground = async function() {
            if (!selectedFileBase64) {
                errorMessage.textContent = 'Harap pilih gambar terlebih dahulu.';
                errorMessage.classList.remove('hidden');
                return;
            }

            removeBackgroundButton.disabled = true;
            removeBackgroundButton.classList.add('opacity-50', 'cursor-not-allowed');
            loadingSpinner.classList.remove('hidden');
            buttonText.textContent = 'Memproses...';
            errorMessage.classList.add('hidden');
            resultContainer.classList.add('hidden');

            const systemPrompt = "Hapus latar belakang dari gambar dan berikan kembali gambar dengan latar belakang transparan.";
            const userQuery = "Hapus latar belakang gambar ini.";
            const apiKey = ""; // API key akan otomatis disediakan oleh lingkungan Canvas

            let retries = 0;
            const maxRetries = 3;
            const initialDelay = 1000; // 1 second

            while (retries < maxRetries) {
                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{
                            role: "user",
                            parts: [
                                { text: userQuery },
                                {
                                    inlineData: {
                                        mimeType: "image/png", // Asumsi input adalah PNG, bisa disesuaikan jika diperlukan
                                        data: selectedFileBase64
                                    }
                                }
                            ]
                        }],
                        generationConfig: {
                            responseModalities: ['IMAGE'] // Minta respons berupa gambar
                        },
                        systemInstruction: {
                            parts: [{ text: systemPrompt }]
                        },
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Error API: ${response.status} - ${errorData.error.message || response.statusText}`);
                    }

                    const result = await response.json();
                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                    if (base64Data) {
                        processedImage.src = `data:image/png;base64,${base64Data}`;
                        resultContainer.classList.remove('hidden');
                        break; // Keluar dari loop retry jika berhasil
                    } else {
                        throw new Error('Tidak ada data gambar yang dikembalikan dari API.');
                    }
                } catch (error) {
                    console.error('Gagal menghapus latar belakang:', error);
                    errorMessage.textContent = `Gagal menghapus latar belakang: ${error.message}. Mencoba lagi...`;
                    errorMessage.classList.remove('hidden');
                    retries++;
                    if (retries < maxRetries) {
                        await new Promise(res => setTimeout(res, initialDelay * Math.pow(2, retries - 1)));
                    }
                }
            }

            if (retries === maxRetries) {
                errorMessage.textContent = 'Gagal menghapus latar belakang setelah beberapa kali mencoba. Harap coba lagi nanti.';
                errorMessage.classList.remove('hidden');
            }

            removeBackgroundButton.disabled = false;
            removeBackgroundButton.classList.remove('opacity-50', 'cursor-not-allowed');
            loadingSpinner.classList.add('hidden');
            buttonText.textContent = 'Hapus Latar Belakang';
        };
    </script>
</body>
</html>
